---
{"dg-publish":true,"permalink":"/1 数据分析/2 AB实验/0 AB实验 科学归因与增长利器/2 深入 AB 实验/5 AB 实验的随机分流/","dgPassFrontmatter":true,"noteIcon":"","created":"2023-10-03T07:38:21.181+08:00","updated":"2023-11-27T13:14:50.410+08:00"}
---


1. 随机分组需注意问题
	1. 用户如何被随机分为实验组和对照组
	2. 实验量增加后，流量不够用的问题如何解决
	3. 不同层之间的正交性是如何实现并保证的
	4. 随机分流时如何选择散列算法
# 5.1 单层分流模式

1. AB实验中
	1. 通常使用散列函数将用户随机地分配给不同的桶（bucket）
		1. 将用户分配到桶必须是随机的，且必须是确定性的、不相交的
		2. 比较运行相同实验的任意两个桶，须假定它们在统计上相似，才具有可比性
			1. 这种相似性可以通过 AA 实验进行验证
	2. 每个桶中的用户数量应该大致相同
		1. 如果进一步按照属性细分，各个桶的切片数据也将大致相同
	3. 关键指标（目标、保护、质量）应该具有大致相同的值
	4. 需要配置相应的监控任务
		1. 谷歌、微软，通过监控桶特征发现了随机化代码中的错误
		2. 对每个实验中的桶进行重新随机化或洗牌，用来处理残留效应，防止之前实验污染当前实验的桶
2. 单层分流
	1. 单层，指不重复利用用户，同一时间内，用户最多只会参与一个实验
		1. 缺点，实验数量被限制，要确保每个实验有足够的实验样本以获得足够的功效
	2. 操作上，单层系统中管理实验流量可能很有挑战性
# 5.2 正交分层模式

1. 为解决单层随机分配下流量不够用的问题，要将实验扩展到单层方法所能实现的范围之外，需要转移至某种并发实验系统
2. 并发系统中
	1. 每个用户可以同时进行多个实验
	2. 实现方法
		1. 拥有多个实验层，每一层的行为类似于单层方法
		2. 为确保层间实验的正交性，在把用户分配到桶时，也会添加层id，称为盐值
		3. 这就是业界通用的正交分层模式，即通过散列函数和加盐值方法实现流量复用
3. 正交分层模式的2个关键点
	1. 正交性是如何保证的
	2. 如何确定分多少层且如何使用
## 5.2.1 正交性问题

1. 简单来说，第一层所有用户都均匀随机分不到其他层的实验离，则可以认为第一层实验是符合正交性的，其他层实验依此类推
2. 各层之间类似平行关系，不相交，不影响，这样各层之间的影响就通过正交随机打散的方式被抵消了，每一层看到的仍然是该层中这个特征的实验效果
3. 数学验证（略）参考书 p85-87：
	1. 证明了当符合正交性时，实验层2中的实验组对于实验1中实验组A、B的影响是完全一样的，在对比 A、B两组实验效果的时候，实验组 C 的效果就完全被抵消了
	2. ![image.png](https://xunhuanke-1309879741.cos.ap-nanjing.myqcloud.com/blog/20231127111114.png)

## 5.2.2 分层问题

1. 极端情况
	1. 每个实验都单独作为一层，这也被称为==全析因实验设计==，每一种可能的因素组合都作为变量进行实验
		1. 平台中每个用户可能同时参与所有实验，对于每个运行的实验，用户都会被分配一个变量（对照组或实验组）
		2. 由于每个实验都与唯一的层id关联，因此所有实验彼此正交
	2. 缺点
		1. 未考虑潜在碰撞，即实验A、实验B之间，结合在一起也许会带来极差的体验效果（即实验之间的互动），由此带来的实验结果也是不正确的
2. 为避免糟糕的用户体验，可使用有限层的划分方式，将系统参数划分为多个层，不同层运行不同类的实验，组合在一起可能会产生较差体验的实验必须处于同一层，防止组合在一起对同一用户运行
3. 有限层关键点
	1. 同类业务互斥且进入同一层（如UI设计）
		1. 同一层是指这一类实验只能放在同一个实验层进行
		2. 核心是避免参数碰撞、互动的发生
		3. 同一层的同类定义是相对的
			1. 数据量小，可以直接定义 UI层
			2. 数据量大，UI层可以拆分为 文字字体、文字颜色等，放入不同的实验层
	2. 不同类业务可以拆分到不同层，并行进行，保证实验流量足够，通过正交实现层间效果相互影响的隔离
4. 贯穿域
	1. 进行各种跨层的联合实验
5. 实际工程中
	1. 将层和域演变为各种复杂的组合，这些不同层和域的构造组合，使用的是一种嵌套平台设计
	2. 具体选择什么样的组合，取决于业务的实际情况和复杂度
	3. 无论选择什么组合，最好具备灵活组合的能力
6. 经典层域架构
	1. ![image.png](https://xunhuanke-1309879741.cos.ap-nanjing.myqcloud.com/blog/20231127112348.png)
		1. a 包含3层的正交层基本框架
		2. b 包含穿透域、正交层的框架
		3. c 包含穿透域、正交层、发布域的框架
		4. d 是一个层域嵌套的复杂框架
7. 域
	1. 没用被分为多个层的流量被称为域
	2. 层和域不是绝对关系，可以在层中分域，在域中分层
	3. 域和域之间的实验是不会重复的，同一个用户只会被分到一个域的实验中

# 5.3 散列算法

1. 散列算法评估主要考虑3个方面
	1. 计算性能
		1. 指开始分流时散列算法的速度，如果速度不够快，可能会影响线上的响应速度
	2. 均匀性
		1. 同层之中分为不同实验组的时候，每个组分到的参与用户的数量尽可能一致
		2. hash_diff 越小，均匀性越好
			1. hash_diff = 同层不同组的实验参与用户数量标准差 / 同层不同组达到实验参与用户数量均值
	3. 相关性
		1. 不同层的组之间的混合尽量均匀，可以用层间差异表示
		2. Layer_diff 越小，相关性越低
2. 常见散列算法
	1. MD
		1. 最常用
	2. SHA
	3. JDB
	4. Murmur
		1. 运行性能更好，抗碰撞性更强，表现出的均匀性、相关性也是最好的，工程实践中运用最多
3. 分流不均的一个重要观察指标，就是两组策略完全一致的用户的实验指标数据出现显著的不一致
4. 分流不均的原因很多
	1. 系统出错
	2. 随机过程用户不同质
	3. 受到遗留实验的影响
5. 为防止分流不均问题，一般在实验开始前现需要进行检验，以确保实验的基础没有偏差
	1. SRM 检验
	2. AA 实验